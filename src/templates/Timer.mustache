{{!*  Riichi mahjong stat GUI
*  Copyright (C) 2016  o.klimenko aka ctizen
*
*  This program is free software: you can redistribute it and/or modify
*  it under the terms of the GNU General Public License as published by
*  the Free Software Foundation, either version 3 of the License, or
*  (at your option) any later version.
*
*  This program is distributed in the hope that it will be useful,
*  but WITHOUT ANY WARRANTY; without even the implied warranty of
*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
*  GNU General Public License for more details.
*
*  You should have received a copy of the GNU General Public License
*  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*}}
<style type="text/css">
 span.success {
   color: #393;
 }

 span.fail {
   color: #c44;
 }

 .navbar-inner {
   display: none;
 }

 .timer, .timer > * {
   font-size: 300px;
   font-family: monospace;
   font-weight: bold;
   margin-top: 200px;
   text-align: center;
   line-height: 1;
 }

 .timer.mini, .timer.mini > * {
   font-size: 100px;
   margin-top: 0;
 }
</style>

<script type="text/javascript">
 $(function() {
   var snd5min = new Audio("/assets/5min.wav"); // buffers automatically when created
   var sndend = new Audio("/assets/endgame.wav"); // buffers automatically when created

   var initialTime = '{{initialTime}}'.split(':');
   var showSeating = '{{showSeating}}' == 'true';
   if (showSeating) {
     $('.timer').addClass('.mini');
     $('.seating').show();
   } else {
     $('.timer').removeClass('.mini');
     $('.seating').hide();
   }
   
   var minutes = parseInt(initialTime[0]);
   var seconds = parseInt(initialTime[1]) / 10;
   var timer = window.setInterval(function() {
     if (seconds == 0) {
       minutes --;
       seconds = 6;
     }

     seconds--;
     var addedZero = '';
     if (seconds < 1) {
       addedZero = '0';
     }

     if (minutes < 85) {
       showSeating = false;
     }

     if (minutes < {{redZoneLength}}) {
       $('#time').css({color: '#f55'});
       if (snd5min) {
         snd5min.play();
         snd5min = false; // нам надо проиграть звук только один раз
       }
     }

     if (minutes < 0) {
       showSeating = true;
       window.clearInterval(timer);
       $('#time').html('СТОП!');
       if (sndend) {
         sndend.play();
         sndend = false; // нам надо проиграть звук только один раз
       }
     } else {
       $('#time').html(minutes + ':' + addedZero + seconds * 10);
     }

     if (showSeating) {
       $('.timer').addClass('mini');
       $('.seating').show();
     } else {
       $('.timer').removeClass('mini');
       $('.seating').hide();
     }
   }, 10000);
 });
</script>

<div class="timer">
    <span id="time">{{initialTime}}</span>
</div>
<div class="seating">
  <hr />
  <h3>РАССАДКА</h3>
  <table class="table table-bordered">
    <tr>
      <th>Стол №</th>
      <th>ВОСТОК</th>
      <th>ЮГ</th>
      <th>ЗАПАД</th>
      <th>СЕВЕР</th>
    </tr>
    {{#seating}}
      <tr>
        <td>{{index}}</td>
        {{#players}}
          <td>{{display_name}} <span class="badge badge-{{zone}}">{{rating}}</span></td>
        {{/players}}
      </tr>
    {{/seating}}
  </table>
</div>
